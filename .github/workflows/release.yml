name: release

# Runs the build and package scripts when a new tagged release is created
on:
  # TODO: Always create a release when pushing to main?
  push:
    tags:
      - "*"

jobs:
  release:
    runs-on: ${{ matrix.os }}

    # Run build script for [home/clinic] in [windows/macOS/ubuntu]
    strategy:
      fail-fast: false
      matrix:
        location: ["home", "clinic"]
        os: [ubuntu-latest, macOS-latest, windows-latest]

    steps:
      # Set up js package
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v3
      - name: ‚éî Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: ./package.json

      - name: Set Package Version and Name
        uses: brown-ccv/gh-actions/get-package-info@main
        id: package_info

      - name: üì• Install Dependencies
        run: npm ci

      # Build the project with the correct location
      - name: Build
        run: npm run build:${{matrix.location}}
        # Test the project
      - name: test
        run: npm test
        env:
          CI: true

      # Build electron app package installers
      # TODO: We might be able to simplify this with "publish" command https://www.electronforge.io/cli#publish
      - name: package electron - windows
        if: startsWith(matrix.os, 'windows')
        run: npm run make:windows
      - name: package electron - linux
        if: startsWith(matrix.os, 'ubuntu')
        run: npm run make:linux
      - name: package electron - mac
        if: startsWith(matrix.os, 'mac')
        run: npm run make:mac

      # Upload installers to github release
      - name: üöÄ Upload Installer to Release (Windows)
        if: startsWith(matrix.os, 'windows')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: out/make/squirrel.windows/x64/${{ steps.package_info.outputs.package_name }}-${{ steps.package_info.outputs.package_version }} Setup.exe
          asset_name: ${{ steps.package_info.outputs.package_name }}-${{ steps.package_info.outputs.package_version }}-${{ matrix.location }}-setup.exe
          tag: ${{ github.ref }}
      - name: üöÄ Upload Installer to Release (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: out/make/deb/x64/${{ steps.package_info.outputs.package_name }}_${{ steps.package_info.outputs.package_version }}_amd64.deb
          asset_name: ${{ steps.package_info.outputs.package_name }}_${{ steps.package_info.outputs.package_version }}_${{ matrix.location }}_amd64.deb
          tag: ${{ github.ref }}
      - name: üöÄ Upload Installer to Release (macOS)
        if: startsWith(matrix.os, 'mac')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: out/make/${{ steps.package_info.outputs.package_name }}-${{ steps.package_info.outputs.package_version }}-x64.dmg
          asset_name: ${{ steps.package_info.outputs.package_name }}-${{ steps.package_info.outputs.package_version }}-${{ matrix.location }}.dmg
          tag: ${{ github.ref }}

      # Update github pages - linux only
      # TODO: Remove GH pages? Can now point user to Firebase deployment
      - name: Deploy to GH Pages
        if: startsWith(matrix.os, 'ubuntu')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
